trigger:
- main

pool:
  name: TestPool1

variables:
- name: imageName
  value: flaskapp

steps:
- checkout: self

# -----------------------------
# Step 1: Debug variables (optional)
# -----------------------------
- script: |
    echo "ACR_USERNAME = $(ACR_USERNAME)"
    echo "ACR_PASSWORD = [REDACTED]"
  displayName: "Debug: Show ACR variables"

# -----------------------------
# Step 2: Login to ACR manually
# -----------------------------
- script: |
    echo "$(ACR_PASSWORD)" | docker login myappflask.azurecr.io \
      --username $(ACR_USERNAME) --password $(ACR_PASSWORD)
  displayName: "Login to ACR"

- script: |
    docker info
    docker login myappflask.azurecr.io --username $(ACR_USERNAME) --password $(ACR_PASSWORD)
  displayName: "Verify ACR Login"

# -----------------------------
# Step 3: Build Docker image
# -----------------------------
- script: |
    docker build -t myappflask.azurecr.io/$(imageName):$(Build.BuildId) .
    docker tag myappflask.azurecr.io/$(imageName):$(Build.BuildId) \
               myappflask.azurecr.io/$(imageName):latest
  displayName: "Build Docker Image"

# -----------------------------
# Step 4: Push image to ACR
# -----------------------------
- script: |
    docker push myappflask.azurecr.io/$(imageName):$(Build.BuildId)
    docker push myappflask.azurecr.io/$(imageName):latest
  displayName: "Push Docker Image"
